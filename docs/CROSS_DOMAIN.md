# Кросс-доменная аутентификация между auth.lumiaai.ru и chat.lumiaai.ru

## Обзор

Система настроена для автоматической аутентификации между доменами `auth.lumiaai.ru` и `chat.lumiaai.ru` через cookies.

## Как это работает

### 1. Пользователь заходит на chat.lumiaai.ru
- Middleware проверяет наличие аутентификационных куки
- Если куки отсутствуют, пользователь перенаправляется на `auth.lumiaai.ru/login?redirect=https://chat.lumiaai.ru/...`

### 2. Пользователь входит на auth.lumiaai.ru
- После успешной аутентификации устанавливаются куки с доменом `.lumiaai.ru`
- Пользователь автоматически перенаправляется обратно на chat.lumiaai.ru

### 3. Автоматический вход на chat.lumiaai.ru
- Компонент `AutoLogin` проверяет куки и выполняет автоматический вход
- Пользователь получает доступ к чату

## Настройка

### 1. DNS и домены
Убедитесь, что оба домена настроены:
- `auth.lumiaai.ru` - домен аутентификации
- `chat.lumiaai.ru` - домен чата

### 2. SSL сертификаты
Оба домена должны иметь валидные SSL сертификаты для работы с secure cookies.

### 3. Настройка cookies
Куки устанавливаются с параметрами:
- `domain: '.lumiaai.ru'` - доступны на всех поддоменах
- `sameSite: 'lax'` - для кросс-доменного взаимодействия
- `secure: true` - в продакшене
- `httpOnly: false` - доступны на клиенте

### 4. Middleware
Middleware настроен для:
- Проверки аутентификации на домене чата
- Автоматического редиректа на домен аутентификации
- Обработки параметра `redirect` для возврата после входа

## API Endpoints

### POST /api/auth
Аутентификация пользователя
```json
{
  "nickname": "username",
  "password": "password",
  "rememberMe": false,
  "redirect": "https://chat.lumiaai.ru/some-page"
}
```

### POST /api/register
Регистрация нового пользователя
```json
{
  "email": "user@example.com",
  "nickname": "username",
  "password": "password",
  "rememberMe": false
}
```

### POST /api/auto-login
Автоматический вход на домене чата

### POST /api/logout
Выход из системы

## Компоненты

### AutoLogin
Автоматически выполняет вход на домене чата при наличии валидных куки.

### AuthForm
Форма аутентификации с поддержкой логина и регистрации.

### AuthGuard
Защищает страницы от неаутентифицированных пользователей.

## Утилиты

### cookies.ts
Функции для работы с аутентификационными куки:
- `setAuthenticationData()` - установка всех данных аутентификации
- `isAuthenticated()` - проверка аутентификации
- `clearLoginCredentials()` - очистка данных

### cross-domain.ts
Функции для кросс-доменного взаимодействия:
- `handleSuccessfulAuth()` - обработка успешной аутентификации
- `handleLogout()` - выход из системы
- `getRedirectParam()` - получение параметра redirect

## Безопасность

### Токены
- Генерируются на сервере
- Содержат временную метку и случайную строку
- В продакшене должны быть JWT токены

### Пароли
- В продакшене должны быть хешированы (bcrypt)
- Добавить валидацию сложности паролей

### CSRF защита
- Использовать CSRF токены для форм
- Проверять Origin заголовки

## Тестирование

### Локальная разработка
Для локальной разработки используйте:
- `localhost:3000` - домен аутентификации
- `localhost:3001` - домен чата

### Тесты
Запустите тесты аутентификации:
```bash
npm run test:auth
```

## Мониторинг

### Логи
Отслеживайте:
- Попытки входа
- Ошибки аутентификации
- Время сессий

### Метрики
- Количество активных пользователей
- Время отклика аутентификации
- Частота ошибок

## Troubleshooting

### Куки не устанавливаются
1. Проверьте SSL сертификаты
2. Убедитесь, что домены настроены правильно
3. Проверьте настройки браузера

### Редирект не работает
1. Проверьте middleware
2. Убедитесь, что параметр redirect валиден
3. Проверьте CORS настройки

### Автоматический вход не работает
1. Проверьте куки в браузере
2. Убедитесь, что API auto-login работает
3. Проверьте логи сервера 